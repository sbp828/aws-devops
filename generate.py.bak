#!/usr/bin/env python3
"""
generate.py â€” Idempotent AWS DevOps Topic Generator
"""

import yaml
import json
from pathlib import Path
from datetime import datetime

# ---------- PATHS ----------
BASE = Path(__file__).parent
DATA = BASE / "data"
OUTPUT = BASE / "aws-devops"
STATE_FILE = DATA / "state/progress.json"
ROADMAP_FILE = DATA / "roadmap/roadmap.yaml"

# ---------- UTILS ----------
def load_yaml(path):
    with open(path) as f:
        return yaml.safe_load(f)

def save_text(path, content):
    path.parent.mkdir(parents=True, exist_ok=True)
    path.write_text(content)

# ---------- STATE ----------
def load_state():
    if not STATE_FILE.exists():
        return {"last_topic_index": 0, "last_run": None}
    return json.loads(STATE_FILE.read_text())

def save_state(state):
    STATE_FILE.parent.mkdir(parents=True, exist_ok=True)
    STATE_FILE.write_text(json.dumps(state, indent=2))

# ---------- CORE ----------
def generate_topic(day_cfg, topic_index):
    artifact = day_cfg["artifact"]
    md_path = OUTPUT / f"{topic_index+1:02d}-{artifact}.md"
    
    if md_path.exists():
        print(f"[INFO] Topic already exists: {md_path.name}, skipping...")
        return False
    
    content = f"""# Topic {topic_index+1}: {artifact}

Generated on {datetime.utcnow().isoformat()} UTC

## Notes
- Placeholder notes for {artifact}
- Add commands, context, and key learnings here
"""
    save_text(md_path, content)
    print(f"[OK] Topic generated: {md_path.name}")
    return True

# ---------- ENGINE ----------
def main():
    roadmap = load_yaml(ROADMAP_FILE)["days"]
    total_topics = len(roadmap)
    
    state = load_state()
    idx = state.get("last_topic_index", 0)
    
    if idx >= total_topics:
        print("[INFO] All topics completed.")
        return
    
    day_cfg = roadmap[str(idx + 1)]
    
    generated = generate_topic(day_cfg, idx)
    
    if generated:
        state["last_topic_index"] = idx + 1
        state["last_run"] = datetime.utcnow().isoformat()
        save_state(state)

if __name__ == "__main__":
    main()
